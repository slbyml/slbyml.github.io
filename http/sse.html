<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="keywords" content="web前端,前端面试题,HTML5,CSS3,CSS,jQuery,JS,JavaScript,前端,vue,博客,技术文章,静水深流,react,18禁"><meta name="author" content="shaolibao"><meta name="google-site-verification" content="018PP6ptGKwOerKbKgiOwbvtEvXE4z1MbWL70S53pUg"><meta name="baidu-site-verification" content="code-zwVA5PHMGk"><meta name="360-site-verification" content="1e93b200c2a643d4d9569c2315bd46a2"><meta name="sogou_site_verification" content="riHbZyBSqZ"><meta name="msvalidate.01" content="18F16D4763157255069DFE0F9ADEF271"><link rel="shortcut icon" href="/link.jpg" type="image/jpg"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#1e90ff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/link.jpg"><link rel="mask-icon" href="/link.jpg" color="#1e90ff"><meta name="msapplication-TileImage" content="/link.jpg"><meta name="msapplication-TileColor" content="#000000"><link rel="stylesheet" href="https://slbblog.oss-cn-beijing.aliyuncs.com/s3Layer.css"><script src="https://hm.baidu.com/hm.js?5ebfc1c23339503a9d4d7fae0f2b1f17" defer="true"></script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5929253442306992" crossorigin="anonymous" async></script><title>探索 SSE：服务器推送技术的魅力与应用 | 静水深流</title><meta name="description" content="SSE早在2004年就开始制定 HTML5 规范草案，08年被各大浏览器实现和支持，并在14年正式被W3C 标准化，但是其一直处于比较边缘化，很少被讨论的状态；本人也仅是只闻其名，直到最近做AI Copilot ，前后端的交互方式由原定的websocket改为了业内常用也比较符合使用场景的sse的交互方式；同时跟同事交流时发现和多人对sse并不是太了解，所以将近期做的调研进行整理输出！">
    <link rel="modulepreload" href="/assets/app.fded88d1.js"><link rel="modulepreload" href="/assets/sse.html.0ded2924.js"><link rel="modulepreload" href="/assets/sse.html.154efe35.js"><link rel="prefetch" href="/assets/index.html.ff05003d.js"><link rel="prefetch" href="/assets/link.html.507bf71d.js"><link rel="prefetch" href="/assets/list.html.ff505004.js"><link rel="prefetch" href="/assets/css.html.7f733be1.js"><link rel="prefetch" href="/assets/free.html.0feb0fcf.js"><link rel="prefetch" href="/assets/http.html.435b0012.js"><link rel="prefetch" href="/assets/js-theory.html.4ebdf728.js"><link rel="prefetch" href="/assets/virtaul.html.91460542.js"><link rel="prefetch" href="/assets/vue.html.36a4848b.js"><link rel="prefetch" href="/assets/webpack.html.81589ebc.js"><link rel="prefetch" href="/assets/cache.html.0cbdab91.js"><link rel="prefetch" href="/assets/diff.html.57dd80cf.js"><link rel="prefetch" href="/assets/easy.html.233613c9.js"><link rel="prefetch" href="/assets/hard.html.9c4848c0.js"><link rel="prefetch" href="/assets/medium.html.3aee136b.js"><link rel="prefetch" href="/assets/sort.html.6f1a08a5.js"><link rel="prefetch" href="/assets/study.html.482502b1.js"><link rel="prefetch" href="/assets/shape.html.2d3e013d.js"><link rel="prefetch" href="/assets/safe.html.d33be7f7.js"><link rel="prefetch" href="/assets/axios.html.6903b3c6.js"><link rel="prefetch" href="/assets/bit.html.66197f95.js"><link rel="prefetch" href="/assets/clone.html.d5486022.js"><link rel="prefetch" href="/assets/copy.html.55febbab.js"><link rel="prefetch" href="/assets/diff.html.2f433539.js"><link rel="prefetch" href="/assets/domCode.html.17db01a3.js"><link rel="prefetch" href="/assets/extend.html.24791588.js"><link rel="prefetch" href="/assets/flatten.html.02862112.js"><link rel="prefetch" href="/assets/genre.html.13d56231.js"><link rel="prefetch" href="/assets/js.html.3fde62f5.js"><link rel="prefetch" href="/assets/type.html.0c84c9b2.js"><link rel="prefetch" href="/assets/blog.html.127ad1f4.js"><link rel="prefetch" href="/assets/blog_old.html.1c40ee5d.js"><link rel="prefetch" href="/assets/oauth.html.46e5d03a.js"><link rel="prefetch" href="/assets/zoom.html.17d16f08.js"><link rel="prefetch" href="/assets/404.html.50edea1e.js"><link rel="prefetch" href="/assets/index.html.8d91edcc.js"><link rel="prefetch" href="/assets/link.html.3f0e9706.js"><link rel="prefetch" href="/assets/list.html.d90ec71c.js"><link rel="prefetch" href="/assets/css.html.71c1ac2d.js"><link rel="prefetch" href="/assets/free.html.b3bde6ce.js"><link rel="prefetch" href="/assets/http.html.23976a1a.js"><link rel="prefetch" href="/assets/js-theory.html.40bc387a.js"><link rel="prefetch" href="/assets/virtaul.html.09b3b2e4.js"><link rel="prefetch" href="/assets/vue.html.0e605c45.js"><link rel="prefetch" href="/assets/webpack.html.a609a935.js"><link rel="prefetch" href="/assets/cache.html.e4f1c686.js"><link rel="prefetch" href="/assets/diff.html.d37ccae3.js"><link rel="prefetch" href="/assets/easy.html.f81ed90e.js"><link rel="prefetch" href="/assets/hard.html.a13d0829.js"><link rel="prefetch" href="/assets/medium.html.8c2f1876.js"><link rel="prefetch" href="/assets/sort.html.7976d748.js"><link rel="prefetch" href="/assets/study.html.519196f5.js"><link rel="prefetch" href="/assets/shape.html.b86a87a0.js"><link rel="prefetch" href="/assets/safe.html.6f870daf.js"><link rel="prefetch" href="/assets/axios.html.3521c585.js"><link rel="prefetch" href="/assets/bit.html.7e38910d.js"><link rel="prefetch" href="/assets/clone.html.a3f4f8c8.js"><link rel="prefetch" href="/assets/copy.html.81e8940a.js"><link rel="prefetch" href="/assets/diff.html.8f3d4f3a.js"><link rel="prefetch" href="/assets/domCode.html.5af9dbb4.js"><link rel="prefetch" href="/assets/extend.html.08b6491f.js"><link rel="prefetch" href="/assets/flatten.html.2dcb730c.js"><link rel="prefetch" href="/assets/genre.html.c2f4dbdd.js"><link rel="prefetch" href="/assets/js.html.6f50e308.js"><link rel="prefetch" href="/assets/type.html.95a7c0e6.js"><link rel="prefetch" href="/assets/blog.html.6f407294.js"><link rel="prefetch" href="/assets/blog_old.html.970a710d.js"><link rel="prefetch" href="/assets/oauth.html.21dac46c.js"><link rel="prefetch" href="/assets/zoom.html.3a97e1d1.js"><link rel="prefetch" href="/assets/404.html.22449b3e.js"><link rel="prefetch" href="/assets/index.6fc1ed56.js"><link rel="prefetch" href="/assets/giscus.9d85e3c1.js"><link rel="prefetch" href="/assets/s3Layer.umd.min.9cf41daf.js">
    <link rel="stylesheet" href="/assets/style.815e0284.css">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!----><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">静水深流</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/list.html" class="" aria-label="文章"><!--[--><!--]--> 文章 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://slbyml.github.io/jsLibrary/" rel="noopener noreferrer" target="_blank" aria-label="demo"><!--[--><!--]--> demo <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/slbyml" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/list.html" class="" aria-label="文章"><!--[--><!--]--> 文章 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://slbyml.github.io/jsLibrary/" rel="noopener noreferrer" target="_blank" aria-label="demo"><!--[--><!--]--> demo <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/slbyml" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">探索 SSE：服务器推送技术的魅力与应用 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/http/sse.html#sse技术介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="sse技术介绍"><!--[--><!--]--> sse技术介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/http/sse.html#sse-与其他通信技术的比较" class="router-link-active router-link-exact-active sidebar-item" aria-label="SSE 与其他通信技术的比较"><!--[--><!--]--> SSE 与其他通信技术的比较 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/http/sse.html#sse-的编程实践" class="router-link-active router-link-exact-active sidebar-item" aria-label="SSE 的编程实践"><!--[--><!--]--> SSE 的编程实践 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/http/sse.html#服务端实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务端实现"><!--[--><!--]--> 服务端实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/http/sse.html#客户端实现-eventsource" class="router-link-active router-link-exact-active sidebar-item" aria-label="客户端实现（EventSource）"><!--[--><!--]--> 客户端实现（EventSource） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/http/sse.html#兼容性问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="兼容性问题"><!--[--><!--]--> 兼容性问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/http/sse.html#sse-的优势与局限性" class="router-link-active router-link-exact-active sidebar-item" aria-label="SSE 的优势与局限性"><!--[--><!--]--> SSE 的优势与局限性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/http/sse.html#优点" class="router-link-active router-link-exact-active sidebar-item" aria-label="优点"><!--[--><!--]--> 优点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/http/sse.html#局限性" class="router-link-active router-link-exact-active sidebar-item" aria-label="局限性"><!--[--><!--]--> 局限性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/http/sse.html#参考" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="探索-sse-服务器推送技术的魅力与应用" tabindex="-1"><a class="header-anchor" href="#探索-sse-服务器推送技术的魅力与应用" aria-hidden="true">#</a> 探索 SSE：服务器推送技术的魅力与应用</h1><p>SSE早在2004年就开始制定 HTML5 规范草案，08年被各大浏览器实现和支持，并在14年正式被W3C 标准化，但是其一直处于比较边缘化，很少被讨论的状态；本人也仅是只闻其名，直到最近做AI Copilot ，前后端的交互方式由原定的websocket改为了业内常用也比较符合使用场景的sse的交互方式；同时跟同事交流时发现和多人对sse并不是太了解，所以将近期做的调研进行整理输出</p><h2 id="sse技术介绍" tabindex="-1"><a class="header-anchor" href="#sse技术介绍" aria-hidden="true">#</a> sse技术介绍</h2><p><code>SSE（Server-Sent Events）</code>是一种基于 HTTP 协议的实时通信技术。其为服务器主动向客户端单向推送实时数据的机制。</p><p>SSE 的工作原理是基于<code> HTTP协议</code>的长链接技术。每当客户端向服务器发起请求后，服务器保持连接的打开状态。一旦有新的数据产生，服务器就能及时向客户端以文本流的形式进行推送。客户端通过监听特定事件来接收和处理这些数据。</p><p>SSE 的出现为那些只需要服务器向客户端单向传递实时数据的场景提供了高效、便捷的解决方案。</p><ul><li>相比传统的轮询方式，SSE 大大减少了不必要的请求和响应，降低了网络开销和服务器负载。</li><li>与其他实时通信技术相比，SSE 凭借其基于 HTTP 协议的特性，具有实现简单、浏览器兼容性好、可靠且高效等优势。它适用于多种应用场景，如新闻实时推送、股票行情更新、实时监控数据展示等。在这些场景中，客户端创建好连接后只需被动接收服务器推送的数据，无需向服务器发送请求，SSE 能够很好地满足需求。</li></ul><h2 id="sse-与其他通信技术的比较" tabindex="-1"><a class="header-anchor" href="#sse-与其他通信技术的比较" aria-hidden="true">#</a> SSE 与其他通信技术的比较</h2><table><thead><tr><th>#</th><th>sse</th><th>websocket</th><th>长轮询（Long Polling）</th><th>XMPP</th></tr></thead><tbody><tr><td>协议</td><td>基于HTTP 协议</td><td>独立的基于 TCP 的全双工通信协议，需要握手升级</td><td>HTTP协议</td><td>专门用于即时通讯和在线状态管理的应用层协议</td></tr><tr><td>通信方式</td><td>单向通信，服务器向客户端推送数据</td><td>双向通信，客户端和服务器都能主动发送消息。</td><td>收到请求后hold住连接，等有内容后再返回,然后重复此动作</td><td>双向通信</td></tr><tr><td>数据格式</td><td>只能传输文本数据</td><td>文本数据，也支持二进制数据。</td><td>和HTTP协议一致</td><td>基于 XML 格式进行数据传输</td></tr><tr><td>重连机制</td><td>客户端在连接中断时会自动尝试重连,重连间隔可以通过 retry 字段设置</td><td>一般需要有心跳机制，在链接断开时手动处理重连逻辑</td><td>定时请求</td><td>主动监听并进行重连</td></tr><tr><td>实时性</td><td>由于单向通信模型，实时性相对较弱，需要服务器定期发送数据</td><td>有更低的延迟和更高的实时性，能立即将数据双向推送</td><td>一般，每次成功获取数据后会再次发送请求</td><td>高</td></tr><tr><td>复杂性</td><td>较低，易于实现和维护</td><td>较高，需要处理连接的建立、维护和断开</td><td>中等，需要重复创建请求</td><td>高</td></tr><tr><td>使用场景</td><td>新闻推送、股票行情更新</td><td>在线聊天、在线游戏</td><td>消息很少的场景</td><td>即时通讯、在线协作等</td></tr></tbody></table><h2 id="sse-的编程实践" tabindex="-1"><a class="header-anchor" href="#sse-的编程实践" aria-hidden="true">#</a> SSE 的编程实践</h2><h3 id="服务端实现" tabindex="-1"><a class="header-anchor" href="#服务端实现" aria-hidden="true">#</a> 服务端实现</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">您好，感谢您的提问。针对您所描述的小米11 Ultra手机USB识别问题，可能是由于以下原因</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">造成的：\n1. USB端口松动：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">长时间使用可能导致USB端口松动，影响接触不良。尝试重新插入USB线缆，</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">确保其牢固连接。\n2. 系统不稳定</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">：偶尔的系统不稳定可能会导致USB识别问题。您可以尝试重启手机，看看是否能够解决问题。\n3. 驱动程序问</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">题：手机的USB驱动程序可能出现故障，导致无法正确识别USB设备。您可以尝</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">试更新手机系统或联系小米官方客服寻求技术支持。\n如果以上方法都</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">无法解决问题，建议您携带手机前往小米授权服务中心进行检测和维修，以确定具体故障原因并获得专业的解决方案。希望能帮到您，祝您使用愉快！</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/stream&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Cache-Control&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;no-cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;text/event-stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Origin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Connection&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;keep-alive&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">flushHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentIdx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sendMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    currentIdx <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">finishReason</span><span class="token operator">:</span> currentIdx <span class="token operator">===</span> arr<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&#39;stop&#39;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">messageId</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> arr<span class="token punctuation">[</span>currentIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentIdx <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port 3100</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="sse-的-http-响应头部通常包括以下内容" tabindex="-1"><a class="header-anchor" href="#sse-的-http-响应头部通常包括以下内容" aria-hidden="true">#</a> SSE 的 HTTP 响应头部通常包括以下内容：</h5><ul><li><strong>Content-Type</strong>: 必须设置为 <code>text/event-stream</code>，标识这是个一个事件流。</li><li><strong>Cache-Control</strong>: 通常设置为 <code>no-store</code> 或 <code>no-cache</code> 以防止缓存。</li><li><strong>Connection</strong>: 可能设置为 <code>keep-alive</code> 表明服务器希望保持连接。</li><li><strong>Retry-After</strong>: 可选，指示客户端在断开连接后重新连接前等待的时间（以毫秒为单位）。但是，这个头不是 SSE 规范的一部分，而是某些服务器使用的非标准方法。</li></ul><h4 id="sse-使用特定的格式来组织数据-以便客户端能够解析这些事件" tabindex="-1"><a class="header-anchor" href="#sse-使用特定的格式来组织数据-以便客户端能够解析这些事件" aria-hidden="true">#</a> SSE 使用特定的格式来组织数据，以便客户端能够解析这些事件：</h4><ol><li><strong>数据行</strong> (<code>data:</code>)： <ul><li>每条数据以 <code>data:</code> 开头。</li><li>数据行可以包含任意数量的文本，只要它们不包含 <code>\n</code>（换行符）。</li><li>如果需要发送多行数据，可以在多个 <code>data:</code> 行中实现。</li><li>每条数据行以 <code>\n</code> 结束。</li></ul></li><li><strong>事件名</strong> (<code>event:</code>)： <ul><li>用于定义事件的名称。</li><li>如果没有指定 <code>event</code>，默认事件名称是 <code>message</code>。</li><li>事件名以 <code>\n</code> 结束。</li></ul></li><li><strong>事件 ID</strong> (<code>id:</code>)： <ul><li>为每个事件提供一个唯一的 ID。</li><li>这有助于客户端在重新连接时恢复事件流。</li><li>事件 ID 以 <code>\n</code> 结束。</li></ul></li><li><strong>重试间隔</strong> (<code>retry:</code>)： <ul><li>建议客户端在重连失败后等待的时间（以毫秒为单位）。</li><li>这个字段是非标准的，但在实践中被广泛使用。</li><li>重试间隔以 <code>\n</code> 结束。</li></ul></li><li><strong>空行</strong> (<code>\n\n</code>)： <ul><li>两个连续的换行符 <code>\n\n</code> 表示一个事件的结束，并开始一个新的事件。</li></ul></li></ol><h3 id="客户端实现-eventsource" tabindex="-1"><a class="header-anchor" href="#客户端实现-eventsource" aria-hidden="true">#</a> 客户端实现（EventSource）</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送数据<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#button&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>window<span class="token punctuation">.</span>EventSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> evtSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&#39;http://localhost:3200/stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      evtSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>finishReason <span class="token operator">===</span> <span class="token string">&#39;stop&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// [done]</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;传输结束&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          evtSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      evtSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;open&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;连接已建立&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      evtSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;连接已关闭&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      evtSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;触发close&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;当前浏览器不支持 SSE&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>EventSource</strong>是一个 Web API，允许网页通过 HTTP 长连接从 Web 服务器接收实时更新，而无需刷新页面或向服务器发送重复请求。</p><p>EventSource的类型定义:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">[</span>Exposed<span class="token operator">=</span><span class="token punctuation">(</span>Window<span class="token punctuation">,</span>Worker<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">interface</span> <span class="token class-name">EventSource</span> <span class="token operator">:</span> EventTarget <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>USVString url<span class="token punctuation">,</span> optional EventSourceInit eventSourceInitDict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">readonly</span> attribute USVString url<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute <span class="token builtin">boolean</span> withCredentials<span class="token punctuation">;</span>

  <span class="token comment">// ready state表明连接的当前状态</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">CONNECTING</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 未连接或正重连</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">OPEN</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 连接已建立，可接受数据</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">CLOSED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 已断开，且不会重连</span>
  <span class="token keyword">readonly</span> attribute unsigned short readyState<span class="token punctuation">;</span>

  <span class="token comment">// networking</span>
  attribute EventHandler onopen<span class="token punctuation">;</span>
  attribute EventHandler onmessage<span class="token punctuation">;</span>
  attribute EventHandler onerror<span class="token punctuation">;</span>
  <span class="token keyword">undefined</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

dictionary EventSourceInit <span class="token punctuation">{</span>
  <span class="token builtin">boolean</span> withCredentials <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，服务器发来的数据，总是触发<code>EventSource</code>实例的<code>message</code>事件。开发者还可以自定义 SSE 事件，这种情况下，发送回来的数据不会触发<code>onmessage</code>事件，而是进入对应自定义事件监听内。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 服务端发送自定义事件</span>
res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">event: foo
data: 自定义事件foo11\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// 客户端接受自定义事件</span>
source<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// 输出：自定义事件foo</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>EventSource默认会在服务器断开时每隔<code>retry（默认3秒）</code>时间进行自动重连，但是实际业务中可能需要对重连进行重新处理来减少前后端处理的压力：比如需要规定重连次数或者规定重连的时间间隔每隔3s、6s、10s最后断开连接等，就需要自行对API进行拦截封装</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 最大重连次数</span>
<span class="token keyword">var</span> retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 当前重连计数</span>

<span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3200/stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
source<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
source<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;An error occurred&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检查重连次数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭当前的 EventSource</span>
        source<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重置 EventSource 并尝试重新连接</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;/server-sent-events-endpoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 秒后尝试重新连接</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum retries reached. Stopping auto-reconnect.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>EventSource虽然是浏览器内置的API，但是它依然有很多限制让我们用起来不是很方便，比如：</p><ul><li>请求方式只能是GET</li><li>无法传递请求体（request body），也就导致参数只能放在url上</li><li>无法自定义请求头</li></ul><p>因此如果需要更灵活的控制请求，可以尝试使用fetch或XMLHttpRequest的方式自行处理返回数据；具体实现可以查看这个<a href="https://github.com/Yaffle/EventSource/blob/03e44c8ea3d83012c3f27da2a2052061b4b4cdd8/src/eventsource.js#L533" target="_blank" rel="noopener noreferrer">polyfill<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="兼容性问题" tabindex="-1"><a class="header-anchor" href="#兼容性问题" aria-hidden="true">#</a> 兼容性问题</h3><p>因为EventSource并不是一个新的规范，因此在<a href="https://caniuse.com/?search=EventSource" target="_blank" rel="noopener noreferrer">现代浏览器上都能得到很好地支持<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，但是对于RN这种非浏览器端运行的应用或者IE却是无法得到支持，那这种情况要如何解决呢？</p><p>幸运的是SSE因为是基于HTTP协议的，所以我们使用XMLHttpRequest进行封装，接收数据，转换成规范格式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> _xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
_xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://localhost:3200/stream&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
_xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_xhr<span class="token punctuation">.</span>status<span class="token punctuation">,</span> _xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> _xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
_xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然，上面代码每次接收到的返回都会包含上一次的返回：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// 第一次返回</span>
data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;您好，感谢您的提问，可能是由于以下原因&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// 第二次返回</span>
data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;您好，感谢您的提问，可能是由于以下原因&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;造成的：\n1. USB端口松动：&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// 第三次返回</span>
data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;您好，感谢您的提问，可能是由于以下原因&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;造成的：\n1. USB端口松动：&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;output&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;finishReason&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;长时间使用可能导致USB端口松动，&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// 第四次返回</span>
……
……
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此还需要我们依于SSE的规范，对返回信息进行分割处理。</p><p>更靠谱更简单的方式是使用一些现成的三方的polyfill，例如： <a href="https://github.com/Yaffle/EventSource?spm=5176.28103460.0.0.297c3da2CABnfG" target="_blank" rel="noopener noreferrer">eventsource-polyfill<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>、<a href="https://github.com/binaryminds/react-native-sse" target="_blank" rel="noopener noreferrer">react-native-sse<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="sse-的优势与局限性" tabindex="-1"><a class="header-anchor" href="#sse-的优势与局限性" aria-hidden="true">#</a> SSE 的优势与局限性</h2><h3 id="优点" tabindex="-1"><a class="header-anchor" href="#优点" aria-hidden="true">#</a> 优点</h3><ol><li><strong>简单易实现</strong>：SSE 的实现相对较为简单，开发人员无需处理复杂的协议和握手流程，降低了开发的难度和时间成本。</li><li>**基于 HTTP 协议，兼容性好：利用了广泛使用和成熟的 HTTP 协议，无需额外的基础设施和特殊配置，与现有网络架构兼容性好。</li><li><strong>支持跨域</strong>：允许客户端通过普通的 AJAX 发起跨域请求，无需服务器进行特殊处理，方便了分布式系统的构建。</li><li><strong>低服务器资源消耗</strong>：相比一些双向通信技术，SSE 在服务器端只需专注于数据的推送，因此资源消耗相对较低，能够处理更多的并发连接。</li></ol><h3 id="局限性" tabindex="-1"><a class="header-anchor" href="#局限性" aria-hidden="true">#</a> 局限性</h3><ol><li><p><strong>单向通信</strong>：SSE 只支持服务器向客户端推送数据，客户端无法主动向服务器发送信息，限制了交互的灵活性。</p></li><li><p><strong>仅支持文本数据</strong>：无法传输二进制数据，对于一些需要传输多媒体等二进制内容的场景不太适用。</p></li><li><p><strong>连接稳定性问题</strong>：可能受到网络环境、服务器性能等因素的影响，导致连接不稳定或中断，需要处理重连等情况。</p></li><li><p><strong>部分浏览器兼容性</strong>：尽管大多数现代浏览器支持，但一些老旧的浏览器可能存在兼容性问题，需要额外的处理或提示。</p></li></ol><p>综合来看，SSE 在适合的场景中能够发挥其优势，为单向数据推送提供高效的解决方案。但在面对复杂的交互需求和特定的数据类型要求时，可能需要考虑其他更全面的通信技术。</p><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2><ul><li><a href="https://html.spec.whatwg.org/multipage/server-sent-events.html#server-sent-events" target="_blank" rel="noopener noreferrer">server-send-evets非标准规范<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events" target="_blank" rel="noopener noreferrer">MDN服务器发送事件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" target="_blank" rel="noopener noreferrer">EventSource<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!--[--><!--[--><ins class="adsbygoogle" style="display:block;text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5929253442306992" data-ad-slot="4632953657"></ins><div class="money"><div class="pay">小红包免费领</div><div class="pay">小礼物走一走</div></div><!----><!--]--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: shaolibao@xiaomi.com">邵礼豹</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 994917123@qq.com">slbyml</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--[--><div class="ff"> 部分内容来源于网络，如有侵权，请留言或联系994917123@qq.com;访问量:<span id="busuanzi_value_site_pv">waiting</span>;访客数:<span id="busuanzi_value_site_uv">waiting</span></div><!--]--><!--]--></main><!--]--></div><div id="gift" style="width:250px;font-size:0;background:#ca3039;display:none;"><img src="https://slbblog.oss-cn-beijing.aliyuncs.com/getMoney.png" style="width:100%;"></div><div id="money" style="width:250px;font-size:0;overflow:hidden;text-align:center;display:none;"><p style="font-size:14px;line-height:1.4;">微信扫码</p><img src="https://slbblog.oss-cn-beijing.aliyuncs.com/wechat.jpg" style="width:100%;"></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.fded88d1.js" defer></script>
  </body>
</html>
